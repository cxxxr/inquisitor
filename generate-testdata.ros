#!/bin/sh
#|-*- mode:lisp -*-|#
#| This generates test datum for inquisitor.
exec ros -Q -- $0 "$@"
|#
(defpackage :inquisitor.generate-testdata
  (:use :cl))

(ql:quickload '(:archive
                :chipz
                :dexador
                :split-sequence)
              :silent t)

(in-package :inquisitor.generate-testdata)

;;; ascii
(defvar +ascii-data+ "Let it suffice now for me to repeat the classic dictum:~aThe Library is a sphere whose exact center is any one of its hexagons and~awhose circumference is inaccessible.")
(defvar +eol-cr+ #\return)
(defvar +eol-lf+ #\newline)
(defvar +eol-crlf+ (format nil (format nil "~a~a" +eol-cr+ +eol-lf+)))
(defvar +eol-lfcr+ (format nil (format nil "~a~a" +eol-lf+ +eol-cr+)))

(defun generate-ascii-data (stream eol-string)
  (let ((s (format nil +ascii-data+ eol-string eol-string)))
    (loop
       :for c :across s
       :do (write-byte (char-code c) stream))))

;;; non-ascii
(defvar +libiconv-base-url+ "http://ftp.gnu.org/pub/gnu/libiconv/")
(defvar +libiconv-version+ "1.14")
(defvar +libiconv-extract-path+ #p"/tmp/")

(defun integer-to-bytes (integer)
  (loop
     :for (q r) := (multiple-value-list (truncate integer (expt 2 8)))
     :with bytes := nil
     :do (setf integer q
               bytes (cons r bytes))
     :while (< 0 q)
     :finally (return (nreverse bytes))))

(defun write-integers-as-bytes (stream &rest integers)
  (loop
     :for integer :in integers
     :do (write-sequence (integer-to-bytes integer) stream)))

(defun generate-non-ascii-data (stream encoding)
  (let ((datapath (format nil "~alibiconv-~a/tests/~a.TXT"
                          +libiconv-extract-path+
                          +libiconv-version+
                          encoding)))
    (with-open-file (fin datapath :direction :input)
      (loop
         :for line := (read-line fin nil :eofp)
         :until (eq line :eofp)
         :for hex := (subseq (first (split-sequence:split-sequence #\tab line)) 2)
         :do (write-integers-as-bytes stream (parse-integer hex :radix 16))))))

;; cf. and port of libiconv-1.14/tests/genutf8.c
(defun generate-utf8 (stream)
  (loop                               ; range 0x0000..0x007f
     :for i1 := 0 :then (incf i1)
     :while (< i1 #x80)
     :do (write-integers-as-bytes stream i1))
  (loop                               ; range 0x0080..0x07ff
     :for i1 := 2 :then (incf i1)
     :while (< i1 32)
     :do (loop
            :for i2 := 0 then (incf i2)
            :while (< i2 64)
            :do (write-integers-as-bytes stream (+ #xc0 i1) (+ #x80 i2))))
  (loop                               ; range 0x0800..0xffff
     :for i1 := 0 :then (incf i1)
     :while (< i1 16)
     :do (loop
            :for i2 := (if (zerop i1) 32 0) then (incf i2)
            :while (< i2 64)
            :do (loop
                   :for i3 := 0 :then (incf i3)
                   :while (< i3 64)
                   :do (write-integers-as-bytes stream (+ #xe0 i1) (+ #x80 i2) (+ #x80 i3))))))

;;; generate
(defvar +dir-spec+
  `(#p"t/data/"
      (#p"ascii/"
         (#p"empty" ,(lambda (stream) nil))
         (#p"ascii" ,#'generate-ascii-data " ")
         (#p"ascii-cr" ,#'generate-ascii-data ,+eol-cr+)
         (#p"ascii-lf" ,#'generate-ascii-data ,+eol-lf+)
         (#p"ascii-crlf" ,#'generate-ascii-data ,+eol-crlf+)
         (#p"ascii-lfcr" ,#'generate-ascii-data ,+eol-lfcr+))
      (#p"unicode/"
         (#p"utf8" ,#'generate-utf8))
      (#p"ja/"
         ;; (#p"jis" ,#'generate-non-ascii-data "")
         (#p"eucjp" ,#'generate-non-ascii-data "EUC-JP")
         (#p"sjis" ,#'generate-non-ascii-data "CP932"))))

(defvar +data-ext+ "txt")

(defun generate-data (spec here)
  (when (cdr spec)
    (let ((path (make-pathname :name (pathname-name (car spec))
                               :directory (pathname-directory here)
                               :type +data-ext+))
          (generate-fn (cadr spec))
          (args (cddr spec)))
      (with-open-file (out path
                           :direction :output
                           :if-exists :supersede
                           :element-type '(unsigned-byte 8))
        (apply generate-fn out args)))))

(defun generate-datum (dir-spec &optional (here #p"."))
  (let ((spec (car dir-spec)))
    (if (uiop:directory-pathname-p spec)
        (loop
           :for s :in (cdr dir-spec)
           :with here := (merge-pathnames spec here)
           :initially (ensure-directories-exist here)
           :do (generate-datum s here))
        (generate-data dir-spec here))))

(defun get-libiconv (iconv-path)
  (let* ((iconv-gz (dex:get (format nil "~alibiconv-~a.tar.gz"
                                    +libiconv-base-url+
                                    +libiconv-version+)
                            :want-stream t))
         (iconv-tar (chipz:make-decompressing-stream 'chipz:gzip iconv-gz))
         (arch (archive:open-archive 'archive:tar-archive iconv-tar
                                     :direction :input))
         (root-dirname))
    (ensure-directories-exist iconv-path)
    (let ((*default-pathname-defaults* iconv-path))
      (loop
         :for entry := (archive:read-entry-from-archive arch)
         :until (null entry)
         :when (null root-dirname)
         :do (setf root-dirname (archive:name entry))
         :do (archive:extract-entry arch entry)))
    root-dirname))

(defun main (&rest argv)
  (declare (ignorable argv))

  (let ((libiconv-dirname))
    (setf libiconv-dirname (get-libiconv +libiconv-extract-path+))

    (generate-datum +dir-spec+ #p".")))
;;; vim: set ft=lisp lisp:
